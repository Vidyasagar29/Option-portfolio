<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Options Portfolio Strategy Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #f8fafc; /* light gray background */
    }

    .fade-in {
      opacity: 0;
      transform: scale(0.95);
      animation: fadeInScale 0.5s forwards;
    }
    @keyframes fadeInScale {
      to { opacity: 1; transform: scale(1); }
    }

    table { width: 100%; border-collapse: collapse; }
  </style>
</head>
<body>
  <div id="dashboardWrapper" class="w-full h-full flex flex-col max-w-[1200px] mx-auto">

    <!-- Header -->
    <header class="bg-black text-white py-2 shadow-md">
      <h2 class="text-center text-xl md:text-2xl font-bold tracking-wide">
        Options Portfolio Strategy Dashboard
      </h2>
    </header>

    <!-- Dashboard -->
    <div class="flex flex-1 flex-col md:flex-row gap-2 p-2">
      
      <!-- Left Panel -->
      <div class="flex-1 flex flex-col gap-2">
        <!-- Portfolio -->
        <div class="bg-white rounded-xl shadow-md p-2 overflow-x-auto">
          <h5 class="text-lg font-semibold text-gray-700 mb-1">Portfolio</h5>

          <!-- Desktop Table -->
          <div class="hidden md:block">
            <table class="text-sm text-left" id="portfolioTable"></table>
          </div>

          <!-- Mobile Cards -->
          <div class="block md:hidden space-y-1" id="portfolioCards"></div>
        </div>

        <!-- Payoff Chart -->
        <div class="bg-white rounded-xl shadow-md p-2 flex flex-col flex-1">
          <h5 class="text-lg font-semibold text-gray-700 mb-1">Payoff Chart</h5>
          <div class="w-full h-[30vh] md:h-[35vh]">
            <canvas id="payoffChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="flex-1 flex flex-col">
        <div class="bg-white rounded-xl shadow-md p-2 flex flex-col flex-1">
          <h5 class="text-lg font-semibold text-gray-700 mb-1">Payoff Table </h5>
          <div id="payoffTableContainer" class="overflow-y-auto flex-1 max-h-[45vh] md:max-h-[550px]">
            <table class="text-sm text-left divide-y divide-gray-200" id="payoffTable"></table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    function formatINR(num) {
      return num.toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    async function loadData() {
      const res = await fetch("/data");
      const data = await res.json();

      const portfolioTable = document.getElementById("portfolioTable");
      const portfolioCards = document.getElementById("portfolioCards");
      const payoffTable = document.getElementById("payoffTable");

      const first = data[0];
      const last = data[data.length - 1];
      const qty = 2475;

      const buySpot = first.nifty_close, buyPut = first.put_price, sellCall = first.call_price;
      const curSpot = last.nifty_close, curPut = last.put_price, curCall = last.call_price;

      const portfolio = [
        { symbol: "NIFTY", qty: qty, buyPrice: buySpot, curPrice: curSpot, pnl: (curSpot - buySpot) * qty },
        { symbol: "PUT 24000", qty: qty, buyPrice: buyPut, curPrice: curPut, pnl: (curPut - buyPut) * qty },
        { symbol: "CALL 27000 (Short)", qty: -qty, buyPrice: sellCall, curPrice: curCall, pnl: (sellCall - curCall) * qty }
      ];

      let totalPNL = 0;

      portfolioTable.innerHTML = `
        <thead class="bg-gray-100 text-gray-700 text-sm font-semibold">
          <tr>
            <th class="px-1 py-1">Symbol</th>
            <th class="px-1 py-1">Qty</th>
            <th class="px-1 py-1">Buy/Sell Price</th>
            <th class="px-1 py-1">Current Price</th>
            <th class="px-1 py-1">P&L</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
        ${portfolio.map(asset => {
          totalPNL += asset.pnl;
          return `<tr>
            <td class="px-1 py-1">${asset.symbol}</td>
            <td class="px-1 py-1">${asset.qty}</td>
            <td class="px-1 py-1">₹${formatINR(asset.buyPrice)}</td>
            <td class="px-1 py-1">₹${formatINR(asset.curPrice)}</td>
            <td class="px-1 py-1 ${asset.pnl >= 0 ? "text-green-600 font-medium" : "text-red-600 font-medium"}">₹${formatINR(asset.pnl)}</td>
          </tr>`;
        }).join("")}
        <tr class="font-bold border-t-2 border-purple-500">
          <td colspan="4" class="text-right px-1 py-1">Total P&L</td>
          <td class="px-1 py-1">${formatINR(totalPNL)}</td>
        </tr>
        </tbody>`;

      portfolioCards.innerHTML = portfolio.map(asset => `
        <div class="fade-in border rounded-lg shadow-sm p-1 bg-gray-50">
          <div class="flex justify-between">
            <span class="font-semibold">${asset.symbol}</span>
            <span class="${asset.pnl >= 0 ? "text-green-600 font-medium" : "text-red-600 font-medium"}">₹${formatINR(asset.pnl)}</span>
          </div>
          <div class="text-sm text-gray-600 mt-0.5">Qty: ${asset.qty}</div>
          <div class="text-sm text-gray-600">Buy/Sell: ₹${formatINR(asset.buyPrice)}</div>
          <div class="text-sm text-gray-600">Current: ₹${formatINR(asset.curPrice)}</div>
        </div>
      `).join("") + `
        <div class="fade-in border rounded-lg shadow p-1 bg-purple-50 font-bold text-gray-800 flex justify-between">
          <span>Total P&L</span>
          <span>${formatINR(totalPNL)}</span>
        </div>`;

      const ctx = document.getElementById("payoffChart").getContext("2d");
      if (window.payoffChartInstance) window.payoffChartInstance.destroy();

      window.payoffChartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.map(item => item.date),
          datasets: [{
            data: data.map(item => item.pnl),
            borderColor: "#894fdc",
            backgroundColor: "rgba(137,79,220,0.2)",
            borderWidth: 3,
            pointRadius: 0,
            pointHoverRadius: 0,
            tension: 0,
            fill: true,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                title: ctx => `Date: ${ctx[0].label}`,
                label: ctx => `P&L: ₹${formatINR(ctx.parsed.y)}`
              }
            },
          },
          interaction: { mode: 'nearest', axis: 'x', intersect: false },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                callback: (val, index) => {
                  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                  return monthNames[new Date(data[index].date).getMonth()];
                },
                color: "#4b5563",
                maxRotation: 0,
                minRotation: 0
              }
            },
            y: {
              ticks: { callback: val => "₹" + formatINR(val), color: "#4b5563" },
              grid: { color: "rgba(137,79,220,0.07)" }
            }
          }
        }
      });

      payoffTable.innerHTML = `
        <thead class="bg-gray-100 text-gray-700 text-sm font-semibold">
          <tr>
            <th class="px-1 py-1">Date</th>
            <th class="px-1 py-1">Spot</th>
            <th class="px-1 py-1">Put</th>
            <th class="px-1 py-1">Call</th>
            <th class="px-1 py-1">P&L</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          ${data.map(row => `
            <tr>
              <td class="px-1 py-1">${row.date}</td>
              <td class="px-1 py-1">₹${formatINR(row.nifty_close)}</td>
              <td class="px-1 py-1">₹${formatINR(row.put_price)}</td>
              <td class="px-1 py-1">₹${formatINR(row.call_price)}</td>
              <td class="px-1 py-1 ${row.pnl >= 0 ? "text-green-600 font-medium" : "text-red-600 font-medium"}">₹${formatINR(row.pnl)}</td>
            </tr>`).join("")}
        </tbody>`;
    }

    loadData();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/iframe-resizer/js/iframeResizer.contentWindow.min.js"></script>

</body>
</html>
